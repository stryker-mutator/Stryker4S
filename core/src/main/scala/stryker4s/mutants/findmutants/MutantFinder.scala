package stryker4s.mutants.findmutants

import better.files.File
import grizzled.slf4j.Logging
import stryker4s.model.{Mutant, MutationsInSource}

import scala.meta.Source
import scala.meta.parsers.{Parsed, XtensionParseInputLike}

class MutantFinder(matcher: MutantMatcher) extends Logging {

  def mutantsInFile(filePath: File): MutationsInSource = {
    val parsedSource = parseFile(filePath)
    MutationsInSource(parsedSource, findMutants(parsedSource))
  }

  def findMutants(source: Source): Seq[Mutant] = {
    source.collect(matcher.allMatchers()).flatten
  }

  def parseFile(file: File): Source =
    file.toJava.parse[Source] match {
      case Parsed.Success(source) =>
        debug(s"Parsed file '$file'")
        source
      case Parsed.Error(_, msg, ex) =>
        error(s"Error while parsing file '$file', $msg")
        throw ex
    }
}
